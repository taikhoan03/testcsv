// Copyright 2012-2014 (c) Peter Å irka <petersirka@gmail.com>

function bindings_create(e,n,t){var i=this;if("undefined"==typeof e||null===e)return $.extend({},i.data("model"));var a=i.data("model");if(i.data("isChange",!1),"undefined"!=typeof a)return"function"==typeof e?(a=e(a),a&&i.data("model",a)):i.data("model",e),bindings_refresh.call(i,t),i.trigger("model-update",[e,t]),i;if("undefined"!=typeof n){if("/"===n.substring(0,1))return i.trigger("template-download-begin",[n]),$.get(n,{},function(e){i.trigger("template-download-end",[n,e]),bindings_create.call(i,i.data("model"),e)}),void 0;-1!==n.indexOf(">")&&-1!==n.indexOf("<")?i.html(n):n=$(n).html()}return i.data("default",$.extend(!0,{},e)),i.data("model",e),i.on("change","input[data-model]",function(e){bindings_internal_change.call(this,e,i,i.data("model"),t)}),i.on("change","textarea[data-model],select[data-model]",function(e){bindings_internal_change.call(this,e,i,i.data("model"),t)}),bindings_refresh.call(i,t),bindings_delay(function(){i.trigger("model-create",[e,t])}),bindings_rebind.call(i)}function bindings_internal_change(e,n,t,i){var a=$(this),r=a.attr("data-model"),d=a.attr("type"),o=a.val();/(MSIE\ [0-8]\.\d+)/.test(navigator.userAgent)||e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),"checkbox"===d&&(o=this.checked);var l=a.attr("data-prepare"),s=$.bindings.prepare.call(a,r,o,l,t,i);"undefined"==typeof s&&(s=$.bindings._prepare.call(a,r,o,l,t,i));var u=$.bindings._validation.call(a,r,s,t,i);if($.bindings.watch.call(a,u,r,s,t,i),u){if(bindings_setvalue.call(a,t,r,s,i),"checkbox"!==d&&"radio"!==d)switch(this.tagName.toLowerCase()){case"input":case"textarea":this.value=$.bindings.format.call(a,r,s,a.attr("data-format"),n.data("model"),i)}else this.checked=o;bindings_rebind.call(n,i),n.data("isChange",!0),bindings_delay(function(){n.trigger("model-change",[r,s,t,i,a]),n.trigger("model-update",[t,r,i])})}}function bindings_json(e,n,t){var i=this,a=$(e),r=a.get(0).tagName.toLowerCase();switch(r){case"input":case"select":case"textarea":return bindings_create.call(i,$.parseJSON(a.val().replace(/\n/g,"\\n")),n,t),void 0}return bindings_create.call(i,$.parseJSON(a.html().replace(/\n/g,"\\n")),n,t),i}function bindings_download(e,n,t,i){var a=this;if("object"==typeof n){t=n,n=t}t||(t={}),t.type||(t.type="GET"),t.dataType||(t.dataType="json");var r=e+JSON.stringify(t);return jquerybindings_cache[r]?void 0:(a.trigger("model-download-begin",[e]),t.success=function(t){a.trigger("model-download-end",[e,t,i]),delete jquerybindings_cache[r],bindings_create.call(a,t,n,i)},t.error=function(n,t){a.trigger("model-download-end",[e,i]),delete jquerybindings_cache[r],a.trigger("model-download-error",[t,e,i])},$.ajax(e,t),a)}function bindings_destroy(){var e=this,n=e.attr("data-name");return e.removeData("model"),e.removeData("default"),e.removeData("isChange"),e.find("input[data-model],textarea[data-model],select[data-model]").unbind("change"),e.trigger("model-destroy",[n]),e}function bindings_default(){var e=this,n=e.data("default"),t=e.attr("data-name");return e.data("model",$.extend({},n)),e.data("isChange",!1),bindings_refresh.call(e,t),bindings_delay(function(){e.trigger("model-default",[n,t])}),e}function bindings_validate(e){var n=this,t=n.data("model"),i=[];return bindings_reflection(t,function(t,a){var r=$.bindings._validation(t,a,e);"undefined"==typeof r||null===r||r||i.push({path:t,value:a,element:n.find('input[data-model="'+t+'"],textarea[data-model="'+t+'"],select[data-model="'+t+'"]')})}),n.trigger("validate",[i,e]),n.trigger("validation",[i,e]),n.trigger("model-validate",[i,e]),n.trigger("model-validation",[i,e]),n}function bindings_set(e,n,t){var i=this,a=i.data("model");if("undefined"==typeof a)return i;"function"==typeof n&&(n=n(bindings_getvalue(a,e,t)));var r=$.bindings._validation(e,n,a,t);return $.bindings.watch.call($('input[data-model="'+e+'"],textarea[data-model="'+e+'"],select[data-model="'+e+'"]'),r,e,n,a,t),r?(bindings_setvalue(a,e,n,t)&&bindings_refresh.call(i,t),i.data("isChange",!0),i.trigger("model-update",[a,e,t]),i):i}function bindings_get(e,n){var t=this,i=t.data("model");return"undefined"!=typeof i?bindings_getvalue(i,e,n):void 0}function bindings_rebind_force(e){var n=this,t=n.data("model");return"undefined"==typeof t?n:(n.find("[data-model]").each(function(){var n=this.tagName.toLowerCase();if("input"!==n&&"select"!==n&&"textarea"!==n){var i=$(this),a=i.attr("data-model"),r=i.attr("data-custom"),d=bindings_getvalue(t,a);if("undefined"!=typeof r)return $.bindings.custom.call(i,a,d,r||"",t,e),void 0;var o=(i.attr("data-encode"),$.bindings.format.call(i,a,d,i.attr("data-format"),t,e));"undefined"==typeof o&&(o=""),"string"!=typeof o&&(o=o instanceof Array?o.join(", "):null===o?"":o.toString()),i.html(o)}}),n)}function bindings_rebind(e){var n=this,t=n.data("model");if("undefined"==typeof t)return n;var i=n.data("timeout_rebind")||null;null!==i&&clearTimeout(i);var i=setTimeout(function(){bindings_rebind_force.call(n,e)},100);return n.data("timeout_rebind",i),n}function bindings_refresh(e){var n=this,t=n.data("model");if("undefined"==typeof t)return n;var i=n.data("timeout_refresh")||null;null!==i&&clearTimeout(i);var i=setTimeout(function(){bindings_refresh_force.call(n,e)},100);return n.data("timeout_refresh",i),n}function bindings_refresh_force(e){var n=this,t=n.data("model");return"undefined"==typeof t&&(t={},n.data("model",t)),n.find("[data-model]").each(function(){var i=$(this),a=i.attr("data-model")||"",r=!1;switch(this.tagName.toLowerCase()){case"input":case"textarea":case"select":r=!0}var d=bindings_getvalue(t,a,e),o=i.attr("data-format"),l=i.attr("data-custom");if("undefined"==typeof d&&(d=i.attr("data-default")),"undefined"!=typeof l)return $.bindings.custom.call(i,a,d,l||"",t,e),void 0;var s=$.bindings.format.call(n,a,d,o,t,e);if(r){var u=i.attr("type");if("checkbox"===u)this.checked=d===!0||1===d||"true"===d;else if("radio"===u){if(this.value!=d)return;this.checked=!0}else i.val(s)}else{var c=i.attr("data-encode"),f="undefined"!=typeof c&&"false"===c;"undefined"==typeof s&&(s=""),"string"!=typeof s&&(s=s instanceof Array?s.join(", "):null===s?"":s.toString()),i.html(f?s:s.encode())}}),n}function bindings_send(e,n,t,i){var a=this,r=a.data("model");if(!r)return a;var a=this;if($.isPlainObject(e)){var d=n;n=e,e=d}e=e||window.location.pathname,n||(n={}),n.type||(n.type="POST"),n.dataType||(n.dataType="json");var o=e+JSON.stringify(n);return jquerybindings_cache[o]?void 0:(a.trigger("model-send-begin",[e,r,t]),n.contentType="application/json",n.data=JSON.stringify(r),n.success=function(n){a.trigger("model-send-end",[e,r,t]),delete jquerybindings_cache[o],a.trigger("send",[n,r,t]),a.trigger("model-send",[n,r,t]),i&&i(null,n)},n.error=function(n,d){a.trigger("model-send-end",[e,r,t]),delete jquerybindings_cache[o],a.trigger("model-send-error",[d,e,r,t]),i&&i(d,null)},$.ajax(e,n),a)}function bindings_setvalue(e,n,t){n=n.split(".");for(var i=n.length,a=e,r=0;i-1>r;r++)if(a=bindings_findpipe(a,n[r]),"undefined"==typeof a)return!1;return a=bindings_findpipe(a,n[i-1],t),!0}function bindings_findpipe(e,n,t){var i,a=n.lastIndexOf("["),r=-1;if(-1!==a){if(r=parseInt(n.substring(a+1).replace(/\]\[/g,"")),isNaN(r))return;n=n.substring(0,a),i=e[n][r]}else i=e[n];return"undefined"!=typeof i?"undefined"==typeof t?i:(-1!==r?(e[n][r]=t,i=e[n][r]):(e[n]=t,i=e[n]),i):void 0}function bindings_getvalue(e,n){n=n.split(".");for(var t=(n.length,e),i=0;i<n.length;i++)if(t=bindings_findpipe(t,n[i]),"undefined"==typeof t)return;return t}function bindings_reflection(e,n,t){t=t||"";for(var i in e)if("string"==typeof i){var a=t+(""!==t?".":"")+i,r=typeof e[i];"function"!==r&&(n(a,e[i],i),"object"===r&&bindings_reflection(e[i],n,a))}}function bindings_delay(e){setTimeout(function(){e()},120)}var jquerybindings_cache={};$.bindings={},$.fn.bindings=function(e){var n=this;"undefined"==typeof e&&(e="model");var t=n.attr("data-name");switch(e){case"create":return function(e,i){return bindings_create.call(n,e,i,t)};case"json":return function(e,i){return bindings_json.call(n,e,i,t)};case"download":return function(e,i,a){return bindings_download.call(n,e,i,a,t)};case"change":return function(e){return"boolean"!=typeof e?n.data("isChange")||!1:n.data("isChange",e)};case"refresh":return bindings_refresh.call(n,t),void 0;case"destroy":return bindings_destroy.call(n,t),void 0;case"default":return bindings_default.call(n,t),void 0;case"validate":case"validation":return bindings_validate.call(n,t);case"set":return function(e,i){return bindings_set.call(n,e,i,t)};case"get":return function(e){return bindings_get.call(n,e,t)};case"update":return function(e){return bindings_create.call(n,e,t)};case"model":return bindings_create.call(n,null,null,t);case"send":return function(e,i,a){if("function"==typeof i){a=i,i=a}return bindings_send.call(n,e,i,t,a)}}return n},$.bindings.prepare=function(){},$.bindings._prepare=function(e,n,t,i){if("string"!=typeof n)return n;if(bindings_getvalue(i,e)instanceof Array){for(var a=n.split(","),r=a.length,d=[],o=0;r>o;o++){var l=$.trim(a[o]);l.length>0&&d.push(l)}return d}return n.isNumber()?"0"===n[0]&&n.length>1?n:(n=n.replace(",","."),-1===n.indexOf(".")?parseInt(n):parseFloat(n)):n},$.bindings.format=function(e,n){return n instanceof Array?n.join(", "):n},$.bindings.custom=function(){},$.bindings.watch=function(){},$.bindings.validation=function(){return!0},$.bindings._validation=function(e,n,t,i){var a=$.bindings.validation(e,n,t,i);return("undefined"==typeof a||null===a)&&(a=!0),a===!0},String.prototype.isNumber||(String.prototype.isNumber=function(e){var n=this,t=n.length;if(0===t)return!1;e=e||!0;for(var i=0;t>i;i++){var a=n.charCodeAt(i);if(!e||44!==a&&46!==a){if(48>a||a>57)return!1}else e=!1}return!0}),String.prototype.encode||(String.prototype.encode=function(){return this.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")});